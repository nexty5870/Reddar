<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report.focus_name }} - Reddar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'serif': ['Playfair Display', 'Georgia', 'serif'],
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        'paper': '#faf9f6',
                        'charcoal': '#1a1a1a',
                        'slate-struct': '#334155',
                        'cyan-accent': '#0066cc',
                        'muted': '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #faf9f6;
            color: #1a1a1a;
        }

        /* Grid background pattern */
        .grid-bg {
            background-image:
                radial-gradient(circle, #e2e8f0 1px, transparent 1px);
            background-size: 16px 16px;
            background-position: 0 0;
        }

        /* Typography */
        .font-editorial { font-family: 'Playfair Display', Georgia, serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Sharp components - no rounded corners */
        .card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            transition: border-color 0.15s linear;
        }
        .card:hover {
            border-color: #94a3b8;
        }

        /* Buttons */
        .btn-primary {
            background: #1a1a1a;
            color: white;
            transition: background 0.15s linear;
        }
        .btn-primary:hover {
            background: #334155;
        }

        /* Focus states */
        .focus-sharp:focus {
            outline: 2px solid #0066cc;
            outline-offset: 2px;
        }

        /* Selection color */
        ::selection {
            background: #e0f2fe;
            color: #1a1a1a;
        }

        /* Status badges */
        .badge-high {
            background: #dcfce7;
            color: #166534;
        }
        .badge-medium {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-low {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Evidence card */
        .evidence-card {
            background: #f8fafc;
            border-left: 2px solid #0066cc;
        }

        /* Expandable content */
        .expand-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s linear;
        }
        .expand-content.open {
            max-height: 2000px;
        }

        /* Opportunity card */
        .opportunity-card {
            background: white;
            border: 1px solid #e2e8f0;
            transition: all 0.15s linear;
        }
        .opportunity-card:hover {
            border-color: #94a3b8;
        }
        .opportunity-card.expanded {
            border-color: #0066cc;
            border-left-width: 2px;
        }

        /* Chat panel */
        .chat-panel {
            transform: translateX(100%);
            transition: transform 0.2s linear;
        }
        .chat-panel.open {
            transform: translateX(0);
        }

        /* Metric value */
        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
    </style>
</head>
<body class="min-h-screen antialiased grid-bg">
    <!-- Header with Meta Bar -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <!-- Meta Bar -->
        <div class="border-b border-slate-100 bg-slate-50">
            <div class="container mx-auto px-6 py-1.5 max-w-5xl">
                <div class="font-mono text-xs text-muted flex items-center gap-4">
                    <span>VIEW: /report/{{ report.id[:8] }}</span>
                    <span class="text-slate-300">|</span>
                    <span>FOCUS: {{ report.focus_name }}</span>
                    <span class="text-slate-300">|</span>
                    <span>{{ (report.updated_at or report.generated_at or '')[:10] }}</span>
                </div>
            </div>
        </div>
        <!-- Main Header -->
        <div class="container mx-auto px-6 py-4 max-w-5xl">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <a href="/" class="font-mono text-muted hover:text-cyan-accent transition-colors text-sm flex items-center gap-2">
                        <span>&lt;-</span>
                        <span class="text-slate-struct">┌─</span>
                        <span class="font-editorial font-bold text-charcoal">Reddar</span>
                        <span class="text-slate-struct">─┐</span>
                    </a>
                </div>
                <div class="flex items-center gap-6">
                    {% if report.analysis.top_stories %}
                    <!-- News mode stats -->
                    <div class="flex items-center gap-6 font-mono text-sm">
                        <div class="text-right">
                            <span class="text-muted">stories:</span>
                            <span class="metric-value text-cyan-accent ml-1">{{ report.analysis.top_stories | length }}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-muted">releases:</span>
                            <span class="metric-value text-charcoal ml-1">{{ report.analysis.notable_releases | default([]) | length }}</span>
                        </div>
                    </div>
                    {% else %}
                    <!-- Opportunity mode stats -->
                    <div class="flex items-center gap-6 font-mono text-sm">
                        <div class="text-right">
                            <span class="text-muted">opps:</span>
                            <span class="metric-value text-cyan-accent ml-1">{{ report.analysis.opportunities | default([]) | length }}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-muted">pains:</span>
                            <span class="metric-value text-charcoal ml-1">{{ report.analysis.pain_points | default([]) | length }}</span>
                        </div>
                    </div>
                    {% endif %}
                    <button onclick="openChat('{{ report.id }}', '{{ report.focus_name }}')" class="btn-primary px-4 py-2 font-mono text-sm focus-sharp">
                        [CHAT]
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8 max-w-5xl">
        <!-- Executive Summary -->
        {% if report.analysis.executive_summary %}
        <section class="mb-10">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[EXECUTIVE_SUMMARY]</h2>
            <div class="card p-6 border-l-2 border-l-charcoal">
                <p class="font-editorial text-lg text-charcoal leading-relaxed">{{ report.analysis.executive_summary }}</p>
            </div>
        </section>
        {% endif %}

        <!-- NEWS MODE: Top Stories -->
        {% if report.analysis.top_stories %}
        <section class="mb-10">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[TOP_STORIES]</h2>

            <div class="space-y-3">
                {% for story in report.analysis.top_stories %}
                <div class="card p-5 {% if story.importance == 'high' %}border-l-2 border-l-cyan-accent{% endif %}">
                    <div class="flex justify-between items-start gap-4 mb-3">
                        <h3 class="font-editorial text-lg font-semibold text-charcoal">{{ story.headline }}</h3>
                        <div class="flex gap-2 flex-shrink-0">
                            {% set importance = story.importance | default('medium') | lower %}
                            <span class="badge-{{ importance }} px-2 py-0.5 font-mono text-xs font-medium">
                                {{ importance | upper }}
                            </span>
                            {% if story.category %}
                            <span class="bg-slate-100 text-muted px-2 py-0.5 font-mono text-xs">
                                {{ story.category }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <p class="text-sm text-slate-600 mb-3">{{ story.summary }}</p>
                    <div class="flex items-center gap-4 font-mono text-xs text-muted">
                        {% if story.subreddit %}
                        <span class="text-cyan-accent">r/{{ story.subreddit }}</span>
                        {% endif %}
                        {% if story.engagement %}
                        <span>{{ story.engagement }}</span>
                        {% endif %}
                        {% if story.reddit_url %}
                        <a href="{{ story.reddit_url }}" target="_blank" class="text-cyan-accent hover:underline">
                            [LINK]
                        </a>
                        {% endif %}
                    </div>
                    {% if story.links %}
                    <div class="mt-3 flex flex-wrap gap-2">
                        {% for link in story.links %}
                        <a href="{{ link }}" target="_blank" class="font-mono text-xs text-muted hover:text-cyan-accent underline truncate max-w-xs">{{ link }}</a>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% if story.tags %}
                    <div class="flex flex-wrap gap-1 mt-3">
                        {% for tag in story.tags %}
                        <span class="bg-slate-100 text-muted px-2 py-0.5 font-mono text-xs">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- NEWS MODE: Notable Releases -->
        {% if report.analysis.notable_releases %}
        <section class="mb-10">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[NOTABLE_RELEASES]</h2>

            <div class="grid gap-3 md:grid-cols-2">
                {% for release in report.analysis.notable_releases %}
                <div class="card p-5">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-editorial font-semibold text-charcoal">{{ release.name }}</h3>
                        {% if release.reddit_url %}
                        <a href="{{ release.reddit_url }}" target="_blank" class="font-mono text-xs text-cyan-accent hover:underline">
                            [LINK]
                        </a>
                        {% endif %}
                    </div>
                    <p class="text-sm text-slate-600 mb-2">{{ release.description }}</p>
                    {% if release.why_notable %}
                    <p class="font-mono text-xs text-cyan-accent bg-slate-50 p-2 border border-slate-200 mb-2">{{ release.why_notable }}</p>
                    {% endif %}
                    {% if release.links %}
                    <div class="flex flex-wrap gap-2">
                        {% for link in release.links %}
                        <a href="{{ link }}" target="_blank" class="font-mono text-xs text-muted hover:text-cyan-accent underline truncate max-w-xs">{{ link }}</a>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- NEWS MODE: Trending Discussions -->
        {% if report.analysis.trending_discussions %}
        <section class="mb-10">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[TRENDING_DISCUSSIONS]</h2>

            <div class="space-y-3">
                {% for disc in report.analysis.trending_discussions %}
                <div class="card p-5">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-editorial font-semibold text-charcoal">{{ disc.topic }}</h3>
                        <div class="flex items-center gap-2">
                            {% if disc.sentiment %}
                            <span class="font-mono text-xs px-2 py-0.5 {% if disc.sentiment == 'positive' %}badge-high{% elif disc.sentiment == 'negative' %}badge-low{% else %}bg-slate-100 text-muted{% endif %}">
                                {{ disc.sentiment | upper }}
                            </span>
                            {% endif %}
                            {% if disc.reddit_url %}
                            <a href="{{ disc.reddit_url }}" target="_blank" class="font-mono text-xs text-cyan-accent hover:underline">
                                [LINK]
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <p class="text-sm text-slate-600">{{ disc.summary }}</p>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- NEWS MODE: Tools Mentioned -->
        {% if report.analysis.tools_mentioned %}
        <section class="mb-10">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[TOOLS_MENTIONED]</h2>

            <div class="grid gap-3 md:grid-cols-3">
                {% for tool in report.analysis.tools_mentioned %}
                <div class="card p-4">
                    <h3 class="font-editorial font-semibold text-charcoal">{{ tool.name }}</h3>
                    {% if tool.mentions %}
                    <p class="font-mono text-xs text-muted mt-1">{{ tool.mentions }}</p>
                    {% endif %}
                    {% if tool.sentiment %}
                    <p class="font-mono text-xs mt-2 {% if 'positive' in tool.sentiment|lower %}text-green-600{% elif 'negative' in tool.sentiment|lower %}text-red-600{% else %}text-muted{% endif %}">{{ tool.sentiment }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- NEWS MODE: Key Takeaways -->
        {% if report.analysis.key_takeaways %}
        <section class="mb-10">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[KEY_TAKEAWAYS]</h2>

            <div class="card p-6 bg-slate-50 border-slate-200">
                <ul class="space-y-3">
                    {% for takeaway in report.analysis.key_takeaways %}
                    <li class="flex items-start gap-3 text-slate-700">
                        <span class="font-mono text-cyan-accent font-bold">></span>
                        <span>{{ takeaway }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </section>
        {% endif %}

        <!-- OPPORTUNITY MODE: Opportunities -->
        {% if report.analysis.opportunities and not report.analysis.top_stories %}
        <section class="mb-10">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[OPPORTUNITIES]</h2>

            <div class="space-y-3">
                {% for opp in report.analysis.opportunities %}
                <div class="opportunity-card" id="opp-{{ loop.index }}">
                    <!-- Header -->
                    <div class="p-5 cursor-pointer" onclick="toggleOpportunity({{ loop.index }})">
                        <div class="flex justify-between items-start gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="font-mono text-cyan-accent font-bold">#{{ loop.index }}</span>
                                    <h3 class="font-editorial text-lg font-semibold text-charcoal">{{ opp.title }}</h3>
                                </div>
                                <p class="text-sm text-slate-600">{{ opp.description }}</p>
                            </div>
                            <div class="flex gap-2 flex-shrink-0">
                                {% set potential = opp.potential | default('medium') | lower %}
                                <span class="badge-{{ potential }} px-2.5 py-1 font-mono text-xs font-medium">
                                    {{ potential | upper }}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-3 font-mono text-xs text-muted">
                            <span>click to expand</span>
                            <svg class="w-4 h-4 transform transition-transform" id="arrow-{{ loop.index }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>

                    <!-- Expanded Content -->
                    <div class="expand-content" id="content-{{ loop.index }}">
                        <div class="px-5 pb-5 border-t border-slate-100 pt-4 space-y-4">
                            <!-- Demand Signals -->
                            {% if opp.demand_signals %}
                            <div>
                                <h4 class="font-mono text-xs text-muted uppercase tracking-wider mb-2">[DEMAND_SIGNALS]</h4>
                                <p class="text-sm text-charcoal bg-slate-50 p-3 border border-slate-200">{{ opp.demand_signals }}</p>
                            </div>
                            {% endif %}

                            <!-- Competition -->
                            {% if opp.competition %}
                            <div>
                                <h4 class="font-mono text-xs text-muted uppercase tracking-wider mb-2">[COMPETITION]</h4>
                                <p class="text-sm text-charcoal bg-slate-50 p-3 border border-slate-200">{{ opp.competition }}</p>
                            </div>
                            {% endif %}

                            <!-- Evidence -->
                            {% if opp.evidence %}
                            <div>
                                <h4 class="font-mono text-xs text-muted uppercase tracking-wider mb-2">[SOURCE_EVIDENCE]</h4>
                                <div class="space-y-2">
                                    {% for evidence in opp.evidence %}
                                    <div class="evidence-card p-3">
                                        <p class="text-sm text-charcoal">{{ evidence }}</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Tags -->
                            {% if opp.tags %}
                            <div class="flex flex-wrap gap-2 pt-2">
                                {% for tag in opp.tags %}
                                <span class="bg-slate-100 text-muted px-2.5 py-1 font-mono text-xs">{{ tag }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Pain Points -->
        {% if report.analysis.pain_points %}
        <section class="mb-10">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[PAIN_POINTS]</h2>

            <div class="grid gap-3 md:grid-cols-2">
                {% for pain in report.analysis.pain_points %}
                <div class="card p-5">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-editorial font-semibold text-charcoal">{{ pain.problem }}</h3>
                        {% set severity = pain.severity | default('medium') | lower %}
                        <span class="badge-{{ severity }} px-2 py-0.5 font-mono text-xs font-medium">
                            {{ severity | upper }}
                        </span>
                    </div>
                    {% if pain.current_solutions %}
                    <p class="text-sm text-slate-600 mt-2">
                        <span class="font-mono text-xs text-muted">solutions:</span> {{ pain.current_solutions }}
                    </p>
                    {% endif %}
                    {% if pain.frequency %}
                    <p class="font-mono text-xs text-muted mt-2">{{ pain.frequency }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Market Insights -->
        {% if report.analysis.market_insights %}
        <section class="mb-10">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[MARKET_INSIGHTS]</h2>

            <div class="space-y-3">
                {% for insight in report.analysis.market_insights %}
                <div class="card p-5">
                    <p class="font-editorial text-charcoal font-medium">{{ insight.insight }}</p>
                    {% if insight.evidence %}
                    <p class="text-sm text-muted mt-2">{{ insight.evidence }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Recommended Actions -->
        {% if report.analysis.recommended_actions %}
        <section class="mb-10">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[RECOMMENDED_ACTIONS]</h2>

            <div class="space-y-2">
                {% for action in report.analysis.recommended_actions %}
                <div class="card p-4 flex items-start gap-3">
                    <span class="font-mono text-cyan-accent font-bold">></span>
                    <p class="text-charcoal">{{ action }}</p>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Metadata -->
        <div class="font-mono text-xs text-muted border-t border-slate-200 pt-6 mt-10">
            <span class="text-slate-struct">report_id:</span> {{ report.id }}
            <span class="text-slate-300 mx-2">|</span>
            <span class="text-slate-struct">model:</span> {{ (report.metadata or {}).get('model', 'unknown') }}
            <span class="text-slate-300 mx-2">|</span>
            <span class="text-slate-struct">subreddits:</span> {{ report.subreddits_analyzed | join(', ') }}
            <span class="text-slate-300 mx-2">|</span>
            <span class="text-slate-struct">posts:</span> {{ report.total_posts_analyzed or report.posts_analyzed or 0 }}
        </div>
    </main>

    <!-- Footer -->
    <footer class="container mx-auto px-6 py-8 max-w-5xl">
        <div class="text-center font-mono text-xs text-muted">
            <span class="text-slate-struct">┌─</span>
            Reddar v1.0
            <span class="text-slate-struct">─┐</span>
        </div>
    </footer>

    <!-- Chat Slide-Out Panel -->
    <div id="chat-panel" class="chat-panel fixed inset-y-0 right-0 w-full md:w-[480px] bg-white border-l border-slate-200 z-50 flex flex-col">
        <!-- Header -->
        <div class="border-b border-slate-200 px-6 py-4 bg-slate-50">
            <div class="flex items-center justify-between">
                <div>
                    <div class="font-mono text-xs text-muted mb-1">CHAT_SESSION</div>
                    <h2 class="font-editorial text-lg font-bold text-charcoal" id="chat-title">Report Chat</h2>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="clearChatHistory()" class="font-mono text-xs text-muted hover:text-charcoal p-2" title="Clear history">
                        [CLR]
                    </button>
                    <button onclick="closeChat()" class="font-mono text-xs text-muted hover:text-charcoal p-2">
                        [X]
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-paper">
            <div id="chat-welcome" class="text-center py-12">
                <div class="font-mono text-6xl text-slate-200 mb-4">◇</div>
                <h3 class="font-editorial text-lg font-bold text-charcoal mb-2">Ask about this report</h3>
                <p class="text-sm text-muted max-w-xs mx-auto mb-6">I can help you understand the opportunities, pain points, and insights.</p>
                <div class="space-y-2">
                    <button onclick="sendSuggestedQuestion('What are the top 3 opportunities?')" class="block w-full text-left px-4 py-3 card font-mono text-sm text-charcoal hover:border-cyan-accent">
                        > What are the top 3 opportunities?
                    </button>
                    <button onclick="sendSuggestedQuestion('Which pain points have the highest demand?')" class="block w-full text-left px-4 py-3 card font-mono text-sm text-charcoal hover:border-cyan-accent">
                        > Which pain points have highest demand?
                    </button>
                    <button onclick="sendSuggestedQuestion('Summarize the key market insights')" class="block w-full text-left px-4 py-3 card font-mono text-sm text-charcoal hover:border-cyan-accent">
                        > Summarize the key market insights
                    </button>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="border-t border-slate-200 p-4 bg-white">
            <div class="flex gap-3">
                <input type="text"
                       id="chat-input"
                       placeholder="$ ask a question..."
                       class="flex-1 px-4 py-3 bg-slate-50 border border-slate-200 font-mono text-sm text-charcoal placeholder-muted focus-sharp"
                       onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }">
                <button onclick="sendMessage()"
                        id="chat-send-btn"
                        class="btn-primary px-5 py-3 font-mono text-sm focus-sharp disabled:opacity-50">
                    SEND
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Overlay -->
    <div id="chat-overlay" class="fixed inset-0 bg-charcoal/20 hidden z-40" onclick="closeChat()"></div>

    <script>
        // Opportunity toggle
        function toggleOpportunity(index) {
            const content = document.getElementById(`content-${index}`);
            const arrow = document.getElementById(`arrow-${index}`);
            const card = document.getElementById(`opp-${index}`);

            content.classList.toggle('open');
            arrow.classList.toggle('rotate-180');
            card.classList.toggle('expanded');
        }

        // Expand first opportunity by default
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('content-1')) {
                toggleOpportunity(1);
            }
        });

        // Chat functionality
        let currentChatReportId = null;
        let chatIsLoading = false;

        function openChat(reportId, reportName) {
            currentChatReportId = reportId;
            document.getElementById('chat-title').textContent = reportName;
            loadChatHistory(reportId);
            document.getElementById('chat-panel').classList.add('open');
            document.getElementById('chat-overlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            setTimeout(() => document.getElementById('chat-input').focus(), 200);
        }

        function closeChat() {
            document.getElementById('chat-panel').classList.remove('open');
            document.getElementById('chat-overlay').classList.add('hidden');
            document.body.style.overflow = '';
        }

        async function loadChatHistory(reportId) {
            const messagesDiv = document.getElementById('chat-messages');
            const welcomeDiv = document.getElementById('chat-welcome');
            try {
                const response = await fetch(`/api/chat/${reportId}`);
                const data = await response.json();
                if (data.messages && data.messages.length > 0) {
                    welcomeDiv.classList.add('hidden');
                    messagesDiv.innerHTML = '';
                    data.messages.forEach(msg => {
                        const msgEl = document.createElement('div');
                        msgEl.innerHTML = createMessageHTML(msg);
                        messagesDiv.appendChild(msgEl.firstElementChild);
                    });
                    scrollToBottom();
                } else {
                    messagesDiv.innerHTML = '';
                    welcomeDiv.classList.remove('hidden');
                    messagesDiv.appendChild(welcomeDiv);
                }
            } catch (error) {
                messagesDiv.innerHTML = '';
                welcomeDiv.classList.remove('hidden');
                messagesDiv.appendChild(welcomeDiv);
            }
        }

        function createMessageHTML(msg) {
            const isUser = msg.role === 'user';
            const content = escapeHtml(msg.content).replace(/\n/g, '<br>');
            const time = formatTime(msg.timestamp);
            if (isUser) {
                return `<div class="flex justify-end">
                    <div class="bg-charcoal text-white px-4 py-3 max-w-[85%]">
                        <p class="text-sm">${content}</p>
                        <p class="font-mono text-xs text-slate-400 mt-2">${time}</p>
                    </div>
                </div>`;
            } else {
                return `<div class="flex justify-start">
                    <div class="card px-4 py-3 max-w-[85%]">
                        <p class="text-sm text-charcoal">${content}</p>
                        <p class="font-mono text-xs text-muted mt-2">${time}</p>
                    </div>
                </div>`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        async function sendMessage() {
            if (chatIsLoading || !currentChatReportId) return;
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            chatIsLoading = true;
            const sendBtn = document.getElementById('chat-send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = '...';

            document.getElementById('chat-welcome').classList.add('hidden');
            const messagesDiv = document.getElementById('chat-messages');

            const userMsgDiv = document.createElement('div');
            userMsgDiv.innerHTML = createMessageHTML({ role: 'user', content: message, timestamp: new Date().toISOString() });
            messagesDiv.appendChild(userMsgDiv.firstElementChild);

            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'chat-loading';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = '<div class="card px-4 py-3"><span class="font-mono text-sm text-muted">processing...</span></div>';
            messagesDiv.appendChild(loadingDiv);
            scrollToBottom();

            try {
                const response = await fetch(`/api/chat/${currentChatReportId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                document.getElementById('chat-loading')?.remove();
                if (data.error) {
                    showChatError(data.error);
                } else {
                    const assistantDiv = document.createElement('div');
                    assistantDiv.innerHTML = createMessageHTML(data.assistant_message);
                    messagesDiv.appendChild(assistantDiv.firstElementChild);
                }
            } catch (error) {
                document.getElementById('chat-loading')?.remove();
                showChatError('Failed to send message.');
            } finally {
                chatIsLoading = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'SEND';
                scrollToBottom();
            }
        }

        function sendSuggestedQuestion(question) {
            document.getElementById('chat-input').value = question;
            sendMessage();
        }

        function showChatError(message) {
            const messagesDiv = document.getElementById('chat-messages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-center';
            errorDiv.innerHTML = `<span class="font-mono text-sm text-red-600">[ERR] ${escapeHtml(message)}</span>`;
            messagesDiv.appendChild(errorDiv);
        }

        async function clearChatHistory() {
            if (!currentChatReportId || !confirm('Clear chat history?')) return;
            try {
                await fetch(`/api/chat/${currentChatReportId}`, { method: 'DELETE' });
                loadChatHistory(currentChatReportId);
            } catch (error) {}
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && currentChatReportId) closeChat();
        });
    </script>
</body>
</html>
