<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'serif': ['Playfair Display', 'Georgia', 'serif'],
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        'paper': '#faf9f6',
                        'charcoal': '#1a1a1a',
                        'slate-struct': '#334155',
                        'cyan-accent': '#0066cc',
                        'muted': '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #faf9f6;
            color: #1a1a1a;
        }

        /* Grid background pattern */
        .grid-bg {
            background-image:
                radial-gradient(circle, #e2e8f0 1px, transparent 1px);
            background-size: 16px 16px;
            background-position: 0 0;
        }

        /* Typography */
        .font-editorial { font-family: 'Playfair Display', Georgia, serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Sharp components - no rounded corners */
        .card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            transition: border-color 0.15s linear;
        }
        .card:hover {
            border-color: #94a3b8;
        }

        /* Buttons */
        .btn-primary {
            background: #1a1a1a;
            color: white;
            transition: background 0.15s linear;
        }
        .btn-primary:hover {
            background: #334155;
        }

        /* Focus states */
        .focus-sharp:focus {
            outline: 2px solid #0066cc;
            outline-offset: 2px;
        }

        /* ASCII corner brackets */
        .ascii-corners {
            position: relative;
        }
        .ascii-corners::before {
            content: '┌';
            position: absolute;
            top: -2px;
            left: -2px;
            color: #334155;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1;
        }
        .ascii-corners::after {
            content: '┐';
            position: absolute;
            top: -2px;
            right: -2px;
            color: #334155;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1;
        }

        /* Hover accent border */
        .hover-accent:hover {
            border-left: 2px solid #0066cc;
            padding-left: calc(1.25rem - 1px);
        }

        /* Selection color */
        ::selection {
            background: #e0f2fe;
            color: #1a1a1a;
        }

        /* Status indicators */
        .status-ok { color: #0066cc; }
        .status-warn { color: #d97706; }
        .status-err { color: #dc2626; }

        /* Metric highlight */
        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        /* Report card left accent on hover */
        .report-card {
            border-left: 2px solid transparent;
            transition: all 0.15s linear;
        }
        .report-card:hover {
            border-left-color: #0066cc;
            background: #f8fafc;
        }

        /* Chat panel */
        .chat-panel {
            transform: translateX(100%);
            transition: transform 0.2s linear;
        }
        .chat-panel.open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="min-h-screen antialiased grid-bg">
    <!-- Header with Meta Bar -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <!-- Meta Bar -->
        <div class="border-b border-slate-100 bg-slate-50">
            <div class="container mx-auto px-6 py-1.5 max-w-6xl">
                <div class="font-mono text-xs text-muted flex items-center gap-4">
                    <span>VIEW: /dashboard</span>
                    <span class="text-slate-300">│</span>
                    <span>SYNC: <span id="sync-status">connecting...</span></span>
                    <span class="text-slate-300">│</span>
                    <span>{{ llm.provider }}:{{ llm.model }}</span>
                </div>
            </div>
        </div>
        <!-- Main Header -->
        <div class="container mx-auto px-6 py-4 max-w-6xl">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="font-mono text-slate-struct text-lg">┌─</span>
                    <h1 class="font-editorial text-xl font-bold text-charcoal tracking-tight">Reddar</h1>
                    <span class="font-mono text-slate-struct text-lg">─┐</span>
                </div>
                <div class="flex items-center gap-6">
                    <a href="/usage" class="font-mono text-sm text-muted hover:text-cyan-accent transition-colors">
                        [USAGE]
                    </a>
                    <a href="/run" class="btn-primary px-5 py-2 font-mono text-sm focus-sharp">
                        &gt; RUN_AGENT
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8 max-w-6xl">
        <!-- Stats Grid -->
        <section class="mb-10">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">SYSTEM_METRICS</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="card p-5">
                    <div class="font-mono text-xs text-muted mb-2">[REPORTS]</div>
                    <div class="metric-value text-3xl text-charcoal">{{ total_reports }}</div>
                </div>
                <div class="card p-5">
                    <div class="font-mono text-xs text-muted mb-2">[OPPORTUNITIES]</div>
                    <div class="metric-value text-3xl text-cyan-accent">{{ reports | sum(attribute='opportunities_count') }}</div>
                </div>
                <div class="card p-5">
                    <div class="font-mono text-xs text-muted mb-2">[PAIN_POINTS]</div>
                    <div class="metric-value text-3xl text-charcoal">{{ reports | sum(attribute='pain_points_count') }}</div>
                </div>
                <div class="card p-5">
                    <div class="font-mono text-xs text-muted mb-2">[POSTS_ANALYZED]</div>
                    <div class="metric-value text-3xl text-charcoal">{{ reports | sum(attribute='posts_analyzed') }}</div>
                </div>
            </div>
        </section>

        <!-- LLM Status -->
        <section class="mb-10">
            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-mono text-xs text-muted uppercase tracking-wider">LLM_STATUS</h2>
                    <a href="/usage" class="font-mono text-xs text-cyan-accent hover:underline">&gt; details</a>
                </div>
                <div class="flex flex-wrap gap-6 font-mono text-sm">
                    <div>
                        <span class="text-muted">requests:</span>
                        <span id="total-requests" class="text-charcoal ml-1">-</span>
                    </div>
                    <div>
                        <span class="text-muted">tokens:</span>
                        <span id="total-tokens" class="text-cyan-accent ml-1">-</span>
                    </div>
                    <div>
                        <span class="text-muted">avg_latency:</span>
                        <span id="avg-latency" class="text-charcoal ml-1">-</span>
                    </div>
                    <div>
                        <span class="text-muted">status:</span>
                        <span id="connection-status" class="ml-1">[...]</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Focus Areas -->
        <section class="mb-10">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">FOCUS_AREAS</h2>
            <div class="flex flex-wrap gap-3">
                {% for id, area in focus_areas.items() %}
                <div class="card px-4 py-2 font-mono text-sm text-charcoal flex items-center gap-2">
                    {% if area.mode == 'news' %}
                    <span class="text-cyan-accent">■</span>
                    {% else %}
                    <span class="text-muted">□</span>
                    {% endif %}
                    {{ area.name }}
                    <span class="text-muted text-xs">({{ area.subreddits | length }})</span>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Reports -->
        <section>
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-editorial text-2xl font-bold text-charcoal">Reports</h2>
                {% if reports %}
                <span class="font-mono text-xs text-muted">{{ reports | length }} entries</span>
                {% endif %}
            </div>

            {% if reports %}
            <div class="space-y-3">
                {% for report in reports %}
                <a href="/report/{{ report.id }}" class="report-card card block p-5 hover-accent">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="font-editorial text-lg font-semibold text-charcoal">{{ report.focus_name }}</h3>
                                {% if report.total_scans > 1 %}
                                <span class="font-mono text-xs text-muted">[{{ report.total_scans }} scans]</span>
                                {% endif %}
                            </div>
                            <p class="font-mono text-xs text-muted mb-3">
                                updated: {{ report.updated_at[:19] | replace('T', ' ') }}
                            </p>
                            {% if report.executive_summary %}
                            <p class="text-sm text-slate-600 line-clamp-2">{{ report.executive_summary }}</p>
                            {% endif %}
                        </div>
                        <div class="flex gap-6 ml-6 font-mono text-sm">
                            <div class="text-right">
                                <div class="text-xl text-cyan-accent">{{ report.opportunities_count }}</div>
                                <div class="text-xs text-muted">opps</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl text-charcoal">{{ report.pain_points_count }}</div>
                                <div class="text-xs text-muted">pains</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl text-muted">{{ report.posts_analyzed }}</div>
                                <div class="text-xs text-muted">posts</div>
                            </div>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="card p-12 text-center">
                <div class="font-mono text-6xl text-slate-200 mb-4">□</div>
                <h3 class="font-editorial text-xl font-bold text-charcoal mb-2">No reports yet</h3>
                <p class="text-muted mb-6 max-w-sm mx-auto">Run the agent to scan Reddit and discover opportunities, pain points, and market insights.</p>
                <a href="/run" class="btn-primary inline-block px-6 py-3 font-mono text-sm focus-sharp">
                    &gt; START_SCANNING
                </a>
            </div>
            {% endif %}
        </section>
    </main>

    <!-- Footer -->
    <footer class="container mx-auto px-6 py-8 max-w-6xl">
        <div class="text-center font-mono text-xs text-muted">
            <span class="text-slate-struct">┌─</span>
            Reddar v1.0 · {{ llm.model }}
            <span class="text-slate-struct">─┐</span>
        </div>
    </footer>

    <!-- Chat Slide-Out Panel -->
    <div id="chat-panel" class="chat-panel fixed inset-y-0 right-0 w-full md:w-[480px] bg-white border-l border-slate-200 z-50 flex flex-col">
        <!-- Header -->
        <div class="border-b border-slate-200 px-6 py-4 bg-slate-50">
            <div class="flex items-center justify-between">
                <div>
                    <div class="font-mono text-xs text-muted mb-1">CHAT_SESSION</div>
                    <h2 class="font-editorial text-lg font-bold text-charcoal" id="chat-title">Report Chat</h2>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="clearChatHistory()" class="font-mono text-xs text-muted hover:text-charcoal p-2" title="Clear history">
                        [CLR]
                    </button>
                    <button onclick="closeChat()" class="font-mono text-xs text-muted hover:text-charcoal p-2">
                        [X]
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-paper">
            <div id="chat-welcome" class="text-center py-12">
                <div class="font-mono text-6xl text-slate-200 mb-4">◇</div>
                <h3 class="font-editorial text-lg font-bold text-charcoal mb-2">Ask about this report</h3>
                <p class="text-sm text-muted max-w-xs mx-auto mb-6">I can help you understand the opportunities, pain points, and insights.</p>
                <div class="space-y-2">
                    <button onclick="sendSuggestedQuestion('What are the top 3 opportunities?')" class="block w-full text-left px-4 py-3 card font-mono text-sm text-charcoal hover:border-cyan-accent">
                        &gt; What are the top 3 opportunities?
                    </button>
                    <button onclick="sendSuggestedQuestion('Which pain points have the highest demand?')" class="block w-full text-left px-4 py-3 card font-mono text-sm text-charcoal hover:border-cyan-accent">
                        &gt; Which pain points have highest demand?
                    </button>
                    <button onclick="sendSuggestedQuestion('Summarize the key market insights')" class="block w-full text-left px-4 py-3 card font-mono text-sm text-charcoal hover:border-cyan-accent">
                        &gt; Summarize the key market insights
                    </button>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="border-t border-slate-200 p-4 bg-white">
            <div class="flex gap-3">
                <input type="text"
                       id="chat-input"
                       placeholder="$ ask a question..."
                       class="flex-1 px-4 py-3 bg-slate-50 border border-slate-200 font-mono text-sm text-charcoal placeholder-muted focus-sharp"
                       onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }">
                <button onclick="sendMessage()"
                        id="chat-send-btn"
                        class="btn-primary px-5 py-3 font-mono text-sm focus-sharp disabled:opacity-50">
                    SEND
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Overlay -->
    <div id="chat-overlay" class="fixed inset-0 bg-charcoal/20 hidden z-40" onclick="closeChat()"></div>

    <script>
        // Formatting helpers
        function formatNumber(num) {
            if (num === null || num === undefined || num === '-') return '-';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        // Token usage polling
        function updateTokenUsage(data) {
            const statusEl = document.getElementById('connection-status');
            const syncEl = document.getElementById('sync-status');

            if (data.connected) {
                statusEl.innerHTML = '<span class="status-ok">[OK]</span>';
                syncEl.textContent = 'live';
            } else {
                statusEl.innerHTML = '<span class="status-warn">[OFFLINE]</span>';
                syncEl.textContent = 'offline';
            }

            document.getElementById('total-requests').textContent = formatNumber(data.total_requests);
            document.getElementById('total-tokens').textContent = formatNumber(data.total_tokens);
            document.getElementById('avg-latency').textContent = data.avg_latency_ms ? `${formatNumber(data.avg_latency_ms)}ms` : '-';
        }

        async function fetchTokenUsage() {
            try {
                const response = await fetch('/api/token-usage');
                const data = await response.json();
                updateTokenUsage(data);
            } catch (error) {
                updateTokenUsage({ connected: false });
            }
        }

        fetchTokenUsage();
        setInterval(fetchTokenUsage, 5000);

        // Chat functionality
        let currentChatReportId = null;
        let chatIsLoading = false;

        function openChat(reportId, reportName) {
            currentChatReportId = reportId;
            document.getElementById('chat-title').textContent = reportName;
            loadChatHistory(reportId);
            document.getElementById('chat-panel').classList.add('open');
            document.getElementById('chat-overlay').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            setTimeout(() => document.getElementById('chat-input').focus(), 200);
        }

        function closeChat() {
            document.getElementById('chat-panel').classList.remove('open');
            document.getElementById('chat-overlay').classList.add('hidden');
            document.body.style.overflow = '';
            currentChatReportId = null;
        }

        async function loadChatHistory(reportId) {
            const messagesDiv = document.getElementById('chat-messages');
            const welcomeDiv = document.getElementById('chat-welcome');
            try {
                const response = await fetch(`/api/chat/${reportId}`);
                const data = await response.json();
                if (data.messages && data.messages.length > 0) {
                    welcomeDiv.classList.add('hidden');
                    messagesDiv.innerHTML = '';
                    data.messages.forEach(msg => {
                        const msgEl = document.createElement('div');
                        msgEl.innerHTML = createMessageHTML(msg);
                        messagesDiv.appendChild(msgEl.firstElementChild);
                    });
                    scrollToBottom();
                } else {
                    messagesDiv.innerHTML = '';
                    welcomeDiv.classList.remove('hidden');
                    messagesDiv.appendChild(welcomeDiv);
                }
            } catch (error) {
                messagesDiv.innerHTML = '';
                welcomeDiv.classList.remove('hidden');
                messagesDiv.appendChild(welcomeDiv);
            }
        }

        function createMessageHTML(msg) {
            const isUser = msg.role === 'user';
            const content = escapeHtml(msg.content).replace(/\n/g, '<br>');
            const time = formatTime(msg.timestamp);
            if (isUser) {
                return `<div class="flex justify-end">
                    <div class="bg-charcoal text-white px-4 py-3 max-w-[85%]">
                        <p class="text-sm">${content}</p>
                        <p class="font-mono text-xs text-slate-400 mt-2">${time}</p>
                    </div>
                </div>`;
            } else {
                return `<div class="flex justify-start">
                    <div class="card px-4 py-3 max-w-[85%]">
                        <p class="text-sm text-charcoal">${content}</p>
                        <p class="font-mono text-xs text-muted mt-2">${time}</p>
                    </div>
                </div>`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        async function sendMessage() {
            if (chatIsLoading || !currentChatReportId) return;
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            chatIsLoading = true;
            const sendBtn = document.getElementById('chat-send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = '...';

            document.getElementById('chat-welcome').classList.add('hidden');
            const messagesDiv = document.getElementById('chat-messages');

            const userMsgDiv = document.createElement('div');
            userMsgDiv.innerHTML = createMessageHTML({ role: 'user', content: message, timestamp: new Date().toISOString() });
            messagesDiv.appendChild(userMsgDiv.firstElementChild);

            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'chat-loading';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = '<div class="card px-4 py-3"><span class="font-mono text-sm text-muted">processing...</span></div>';
            messagesDiv.appendChild(loadingDiv);
            scrollToBottom();

            try {
                const response = await fetch(`/api/chat/${currentChatReportId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                document.getElementById('chat-loading')?.remove();
                if (data.error) {
                    showChatError(data.error);
                } else {
                    const assistantDiv = document.createElement('div');
                    assistantDiv.innerHTML = createMessageHTML(data.assistant_message);
                    messagesDiv.appendChild(assistantDiv.firstElementChild);
                }
            } catch (error) {
                document.getElementById('chat-loading')?.remove();
                showChatError('Failed to send message.');
            } finally {
                chatIsLoading = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'SEND';
                scrollToBottom();
            }
        }

        function sendSuggestedQuestion(question) {
            document.getElementById('chat-input').value = question;
            sendMessage();
        }

        function showChatError(message) {
            const messagesDiv = document.getElementById('chat-messages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-center';
            errorDiv.innerHTML = `<span class="font-mono text-sm status-err">[ERR] ${escapeHtml(message)}</span>`;
            messagesDiv.appendChild(errorDiv);
        }

        async function clearChatHistory() {
            if (!currentChatReportId || !confirm('Clear chat history?')) return;
            try {
                await fetch(`/api/chat/${currentChatReportId}`, { method: 'DELETE' });
                loadChatHistory(currentChatReportId);
            } catch (error) {}
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && currentChatReportId) closeChat();
        });
    </script>
</body>
</html>
