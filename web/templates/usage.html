<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Usage - Reddar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'serif': ['Playfair Display', 'Georgia', 'serif'],
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        'paper': '#faf9f6',
                        'charcoal': '#1a1a1a',
                        'slate-struct': '#334155',
                        'cyan-accent': '#0066cc',
                        'muted': '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #faf9f6;
            color: #1a1a1a;
        }

        /* Grid background pattern */
        .grid-bg {
            background-image:
                radial-gradient(circle, #e2e8f0 1px, transparent 1px);
            background-size: 16px 16px;
            background-position: 0 0;
        }

        /* Typography */
        .font-editorial { font-family: 'Playfair Display', Georgia, serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Sharp components */
        .card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
        }

        /* Selection */
        ::selection {
            background: #e0f2fe;
            color: #1a1a1a;
        }

        /* Token breakdown bar */
        .breakdown-bar {
            background: #e2e8f0;
            height: 4px;
        }
    </style>
</head>
<body class="min-h-screen antialiased grid-bg">
    <!-- Header with Meta Bar -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <!-- Meta Bar -->
        <div class="border-b border-slate-100 bg-slate-50">
            <div class="container mx-auto px-6 py-1.5 max-w-6xl">
                <div class="font-mono text-xs text-muted flex items-center gap-4">
                    <span>VIEW: /usage</span>
                    <span class="text-slate-300">|</span>
                    <span>MODE: analytics</span>
                    <span class="text-slate-300">|</span>
                    <span id="connection-status">[...]</span>
                </div>
            </div>
        </div>
        <!-- Main Header -->
        <div class="container mx-auto px-6 py-4 max-w-6xl">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <a href="/" class="font-mono text-muted hover:text-cyan-accent transition-colors text-sm flex items-center gap-2">
                        <span>&lt;-</span>
                        <span class="text-slate-struct">┌─</span>
                        <span class="font-editorial font-bold text-charcoal">Reddar</span>
                        <span class="text-slate-struct">─┐</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8 max-w-6xl">
        <!-- Summary Stats -->
        <section class="mb-8">
            <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[SUMMARY_METRICS]</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                <div class="card p-5">
                    <div class="font-mono text-xs text-muted mb-2">[REQUESTS]</div>
                    <div id="total-requests" class="font-mono text-2xl font-medium text-charcoal">-</div>
                </div>
                <div class="card p-5">
                    <div class="font-mono text-xs text-muted mb-2">[TOTAL_TOKENS]</div>
                    <div id="total-tokens" class="font-mono text-2xl font-medium text-cyan-accent">-</div>
                </div>
                <div class="card p-5">
                    <div class="font-mono text-xs text-muted mb-2">[PROMPT]</div>
                    <div id="prompt-tokens" class="font-mono text-2xl font-medium text-charcoal">-</div>
                </div>
                <div class="card p-5">
                    <div class="font-mono text-xs text-muted mb-2">[COMPLETION]</div>
                    <div id="completion-tokens" class="font-mono text-2xl font-medium text-charcoal">-</div>
                </div>
                <div class="card p-5">
                    <div class="font-mono text-xs text-muted mb-2">[AVG_LATENCY]</div>
                    <div id="avg-latency" class="font-mono text-2xl font-medium text-charcoal">-</div>
                </div>
            </div>
        </section>

        <!-- Charts Row -->
        <section class="mb-8">
            <div class="grid md:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[TOKEN_USAGE]</h2>
                    <div class="h-64">
                        <canvas id="tokensChart"></canvas>
                    </div>
                </div>

                <div class="card p-6">
                    <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[LATENCY]</h2>
                    <div class="h-64">
                        <canvas id="latencyChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Token Breakdown -->
        <section class="mb-8">
            <div class="card p-6">
                <h2 class="font-mono text-xs text-muted uppercase tracking-wider mb-4">[TOKEN_BREAKDOWN]</h2>
                <div class="grid md:grid-cols-3 gap-6">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-mono text-xs text-muted">prompt:completion</span>
                            <span id="ratio" class="font-mono text-xs text-charcoal">-</span>
                        </div>
                        <div class="breakdown-bar flex overflow-hidden">
                            <div id="prompt-bar" class="h-full bg-cyan-accent transition-all" style="width: 50%"></div>
                            <div id="completion-bar" class="h-full bg-slate-struct transition-all" style="width: 50%"></div>
                        </div>
                        <div class="flex justify-between mt-2 font-mono text-xs text-muted">
                            <span class="flex items-center gap-1">
                                <span class="w-2 h-2 bg-cyan-accent"></span> prompt
                            </span>
                            <span class="flex items-center gap-1">
                                <span class="w-2 h-2 bg-slate-struct"></span> completion
                            </span>
                        </div>
                    </div>
                    <div>
                        <div class="font-mono text-xs text-muted mb-2">avg_tokens/request:</div>
                        <div id="avg-tokens" class="font-mono text-2xl font-medium text-charcoal">-</div>
                    </div>
                    <div>
                        <div class="font-mono text-xs text-muted mb-2">est_cost @ $0.15/1M:</div>
                        <div id="estimated-cost" class="font-mono text-2xl font-medium text-cyan-accent">$0.00</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Request History -->
        <section>
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-mono text-xs text-muted uppercase tracking-wider">[REQUEST_HISTORY]</h2>
                    <span id="request-count" class="font-mono text-xs text-muted">0 entries</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="font-mono text-xs text-muted uppercase tracking-wider border-b border-slate-200">
                                <th class="text-left py-3 px-3 font-medium">#</th>
                                <th class="text-left py-3 px-3 font-medium">timestamp</th>
                                <th class="text-left py-3 px-3 font-medium">model</th>
                                <th class="text-right py-3 px-3 font-medium">prompt</th>
                                <th class="text-right py-3 px-3 font-medium">completion</th>
                                <th class="text-right py-3 px-3 font-medium">total</th>
                                <th class="text-right py-3 px-3 font-medium">latency</th>
                            </tr>
                        </thead>
                        <tbody id="request-table" class="text-sm">
                            <tr><td colspan="7" class="text-center py-8 font-mono text-muted">loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="container mx-auto px-6 py-8 max-w-6xl">
        <div class="text-center font-mono text-xs text-muted">
            <span class="text-slate-struct">┌─</span>
            Reddar v1.0
            <span class="text-slate-struct">─┐</span>
        </div>
    </footer>

    <!-- Drill-down Modal -->
    <div id="modal" class="fixed inset-0 bg-charcoal/30 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-start justify-center">
            <div class="bg-white border border-slate-200 w-full max-w-5xl relative">
                <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center">
                    <div>
                        <h3 class="font-editorial text-lg font-bold text-charcoal">Request Details</h3>
                        <p id="modal-meta" class="font-mono text-xs text-muted mt-0.5">-</p>
                    </div>
                    <button onclick="closeModal()" class="font-mono text-xs text-muted hover:text-charcoal transition-colors p-2">
                        [X]
                    </button>
                </div>

                <div class="p-6 space-y-6">
                    <div class="grid grid-cols-4 gap-4">
                        <div class="bg-slate-50 border border-slate-200 p-4 text-center">
                            <div id="modal-prompt-tokens" class="font-mono text-xl font-medium text-cyan-accent">-</div>
                            <div class="font-mono text-xs text-muted">prompt</div>
                        </div>
                        <div class="bg-slate-50 border border-slate-200 p-4 text-center">
                            <div id="modal-completion-tokens" class="font-mono text-xl font-medium text-charcoal">-</div>
                            <div class="font-mono text-xs text-muted">completion</div>
                        </div>
                        <div class="bg-slate-50 border border-slate-200 p-4 text-center">
                            <div id="modal-total-tokens" class="font-mono text-xl font-medium text-charcoal">-</div>
                            <div class="font-mono text-xs text-muted">total</div>
                        </div>
                        <div class="bg-slate-50 border border-slate-200 p-4 text-center">
                            <div id="modal-latency" class="font-mono text-xl font-medium text-charcoal">-</div>
                            <div class="font-mono text-xs text-muted">latency</div>
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-mono text-xs text-muted uppercase tracking-wider">[PROMPT]</h4>
                            <button onclick="copyToClipboard('modal-messages-content')" class="font-mono text-xs text-muted hover:text-charcoal">
                                [COPY]
                            </button>
                        </div>
                        <div id="modal-messages" class="bg-slate-50 border border-slate-200 p-4 max-h-80 overflow-y-auto">
                            <pre id="modal-messages-content" class="font-mono text-sm text-charcoal whitespace-pre-wrap">-</pre>
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-mono text-xs text-muted uppercase tracking-wider">[RESPONSE]</h4>
                            <button onclick="copyToClipboard('modal-response-content')" class="font-mono text-xs text-muted hover:text-charcoal">
                                [COPY]
                            </button>
                        </div>
                        <div id="modal-response" class="bg-slate-50 border border-slate-200 border-l-2 border-l-cyan-accent p-4 max-h-96 overflow-y-auto">
                            <pre id="modal-response-content" class="font-mono text-sm text-charcoal whitespace-pre-wrap">-</pre>
                        </div>
                    </div>

                    <div id="modal-reasoning-section" class="hidden">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-mono text-xs text-muted uppercase tracking-wider">[REASONING]</h4>
                            <button onclick="copyToClipboard('modal-reasoning-content')" class="font-mono text-xs text-muted hover:text-charcoal">
                                [COPY]
                            </button>
                        </div>
                        <div class="bg-slate-50 border border-slate-200 p-4 max-h-64 overflow-y-auto">
                            <pre id="modal-reasoning-content" class="font-mono text-sm text-charcoal whitespace-pre-wrap">-</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tokensChart, latencyChart;

        function formatNumber(num) {
            if (num === null || num === undefined || num === '-') return '-';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) +
                   ' ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        function formatLatency(ms) {
            if (!ms) return '-';
            if (ms >= 60000) return (ms / 60000).toFixed(1) + 'm';
            if (ms >= 1000) return (ms / 1000).toFixed(1) + 's';
            return ms + 'ms';
        }

        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { family: 'JetBrains Mono', size: 10 }, color: '#64748b' } },
                    y: { grid: { color: '#e2e8f0' }, ticks: { font: { family: 'JetBrains Mono', size: 10 }, color: '#64748b' } }
                }
            };

            tokensChart = new Chart(document.getElementById('tokensChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Prompt', data: [], backgroundColor: '#0066cc', borderRadius: 0 },
                        { label: 'Completion', data: [], backgroundColor: '#334155', borderRadius: 0 }
                    ]
                },
                options: {
                    ...chartOptions,
                    plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { family: 'JetBrains Mono', size: 10 }, color: '#64748b' } } },
                    scales: { ...chartOptions.scales, x: { ...chartOptions.scales.x, stacked: true }, y: { ...chartOptions.scales.y, stacked: true } }
                }
            });

            latencyChart = new Chart(document.getElementById('latencyChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Latency (s)',
                        data: [],
                        borderColor: '#0066cc',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        fill: true,
                        tension: 0,
                        pointRadius: 3,
                        pointBackgroundColor: '#0066cc',
                        borderWidth: 1,
                    }]
                },
                options: chartOptions
            });
        }

        function updateCharts(requests) {
            const reversed = [...requests].reverse();
            const labels = reversed.map((r, i) => `#${reversed.length - i}`);

            tokensChart.data.labels = labels;
            tokensChart.data.datasets[0].data = reversed.map(r => r.prompt_tokens || 0);
            tokensChart.data.datasets[1].data = reversed.map(r => r.completion_tokens || 0);
            tokensChart.update();

            latencyChart.data.labels = labels;
            latencyChart.data.datasets[0].data = reversed.map(r => (r.latency_ms || 0) / 1000);
            latencyChart.update();
        }

        function updateUI(data) {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = data.connected ? '[CONNECTED]' : '[OFFLINE]';
            statusEl.className = data.connected ? 'font-mono text-xs text-cyan-accent' : 'font-mono text-xs text-amber-600';

            document.getElementById('total-requests').textContent = formatNumber(data.total_requests);
            document.getElementById('total-tokens').textContent = formatNumber(data.total_tokens);
            document.getElementById('prompt-tokens').textContent = formatNumber(data.prompt_tokens);
            document.getElementById('completion-tokens').textContent = formatNumber(data.completion_tokens);
            document.getElementById('avg-latency').textContent = formatLatency(data.avg_latency_ms);

            const promptPct = data.total_tokens > 0 ? (data.prompt_tokens / data.total_tokens) * 100 : 50;
            document.getElementById('prompt-bar').style.width = promptPct + '%';
            document.getElementById('completion-bar').style.width = (100 - promptPct) + '%';
            document.getElementById('ratio').textContent = `${promptPct.toFixed(0)}%:${(100 - promptPct).toFixed(0)}%`;

            const avgTokens = data.total_requests > 0 ? Math.round(data.total_tokens / data.total_requests) : 0;
            document.getElementById('avg-tokens').textContent = formatNumber(avgTokens);

            const cost = (data.total_tokens / 1000000) * 0.15;
            document.getElementById('estimated-cost').textContent = '$' + cost.toFixed(4);

            document.getElementById('request-count').textContent = `${data.recent_logs?.length || 0} entries`;

            window.requestLogs = data.recent_logs || [];

            const tbody = document.getElementById('request-table');
            if (data.recent_logs && data.recent_logs.length > 0) {
                tbody.innerHTML = data.recent_logs.map((log, i) => `
                    <tr class="border-b border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors" onclick="openModal(${i})">
                        <td class="py-3 px-3 font-mono text-xs text-muted">${i + 1}</td>
                        <td class="py-3 px-3 font-mono text-xs text-charcoal">${formatDate(log.timestamp)}</td>
                        <td class="py-3 px-3">
                            <span class="font-mono text-xs text-cyan-accent">${log.model || '-'}</span>
                        </td>
                        <td class="py-3 px-3 text-right font-mono text-xs text-charcoal">${formatNumber(log.prompt_tokens)}</td>
                        <td class="py-3 px-3 text-right font-mono text-xs text-charcoal">${formatNumber(log.completion_tokens)}</td>
                        <td class="py-3 px-3 text-right font-mono text-xs font-medium text-charcoal">${formatNumber(log.total_tokens)}</td>
                        <td class="py-3 px-3 text-right font-mono text-xs text-muted">${formatLatency(log.latency_ms)}</td>
                    </tr>
                `).join('');

                updateCharts(data.recent_logs);
            } else {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 font-mono text-xs text-muted">no_requests</td></tr>`;
            }
        }

        function openModal(index) {
            const log = window.requestLogs[index];
            if (!log) return;

            document.getElementById('modal-meta').textContent = `${log.model || 'unknown'} | ${formatDate(log.timestamp)}`;

            document.getElementById('modal-prompt-tokens').textContent = formatNumber(log.prompt_tokens);
            document.getElementById('modal-completion-tokens').textContent = formatNumber(log.completion_tokens);
            document.getElementById('modal-total-tokens').textContent = formatNumber(log.total_tokens);
            document.getElementById('modal-latency').textContent = formatLatency(log.latency_ms);

            let messagesText = '';
            if (log.messages && log.messages.length > 0) {
                messagesText = log.messages.map(m => `[${m.role.toUpperCase()}]\n${m.content || ''}`).join('\n\n---\n\n');
            } else {
                messagesText = '(no prompt data)';
            }
            document.getElementById('modal-messages-content').textContent = messagesText;

            document.getElementById('modal-response-content').textContent = log.response || '(no response data)';

            const reasoningSection = document.getElementById('modal-reasoning-section');
            if (log.reasoning && log.reasoning.trim()) {
                document.getElementById('modal-reasoning-content').textContent = log.reasoning;
                reasoningSection.classList.remove('hidden');
            } else {
                reasoningSection.classList.add('hidden');
            }

            document.getElementById('modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function copyToClipboard(elementId) {
            navigator.clipboard.writeText(document.getElementById(elementId).textContent);
        }

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
        document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });

        async function fetchUsage() {
            try {
                const response = await fetch('/api/token-usage');
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                updateUI({ connected: false });
            }
        }

        initCharts();
        fetchUsage();
        setInterval(fetchUsage, 5000);
    </script>
</body>
</html>
